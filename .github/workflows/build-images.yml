---
name: Build and publish container images

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'
      - 'packages/**'
      - '.github/workflows/build-images.yml'
  workflow_dispatch:
  schedule:
    # run every Monday at 01:30
    - cron: '30 1 * * 1'

jobs:
  build-packages:
    runs-on: ubuntu-latest
    environment: melange
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.BOT_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Create melange.rsa from Github secret
        shell: bash
        env:
          MELANGE_KEY: ${{ secrets.MELANGE_KEY }}
        run: echo "${MELANGE_KEY}" > melange.rsa

      - name: Setup melange
        uses: chainguard-dev/actions/setup-melange@main

      - name: Build apkrane package with Melange
        uses: chainguard-dev/actions/melange-build-pkg@main
        with:
          config: packages/package-apkrane.yaml
          archs: x86_64,arm64
          sign-with-key: true

      - name: Build kubeconform package with Melange
        uses: chainguard-dev/actions/melange-build-pkg@main
        with:
          config: packages/package-kubeconform.yaml
          archs: x86_64,arm64
          sign-with-key: true

      - name: Build flyway package with Melange
        uses: chainguard-dev/actions/melange-build-pkg@main
        with:
          config: packages/package-flyway.yaml
          archs: x86_64,arm64
          sign-with-key: true

      - name: Upload packages
        uses: actions/upload-artifact@v6
        with:
          name: packages
          path: packages/
          retention-days: 1
  build-renovate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.BOT_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Build renovate image
        id: build-renovate
        uses: distroless/actions/apko-publish@main
        with:
          config: images/renovate.yaml
          tag: ghcr.io/${{ github.repository_owner }}/renovate:latest

  build-apko:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build apko image
        id: build-apko
        uses: distroless/actions/apko-publish@main
        with:
          config: images/apko.yaml
          tag: ghcr.io/${{ github.repository_owner }}/apko:latest

  build-docker-dind:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build docker-dind image
        id: build-docker-dind
        uses: distroless/actions/apko-publish@main
        with:
          config: images/docker-dind.yaml
          tag: ghcr.io/${{ github.repository_owner }}/docker-dind:latest

  build-aws-cli:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build aws-cli image
        id: build-aws-cli
        uses: distroless/actions/apko-publish@main
        with:
          config: images/aws-cli.yaml
          tag: ghcr.io/${{ github.repository_owner }}/aws-cli:latest

  build-kubectl:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build kubectl image
        id: build-kubectl
        uses: distroless/actions/apko-publish@main
        with:
          config: images/kubectl.yaml
          tag: ghcr.io/${{ github.repository_owner }}/kubectl:latest

  build-k8s-tools:
    runs-on: ubuntu-latest
    needs: build-packages
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download packages
        uses: actions/download-artifact@v7
        with:
          name: packages
          path: packages/

      - name: Build k8s-tools image
        id: build-k8s-tools
        uses: distroless/actions/apko-publish@main
        with:
          config: images/k8s-tools.yaml
          tag: ghcr.io/${{ github.repository_owner }}/k8s-tools:latest

  build-flyway:
    runs-on: ubuntu-latest
    needs: build-packages
    permissions:
      contents: read
      packages: write
      attestations: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download packages
        uses: actions/download-artifact@v7
        with:
          name: packages
          path: packages/

      - name: Build flyway image
        id: build-flyway
        uses: distroless/actions/apko-publish@main
        with:
          config: images/flyway.yaml
          tag: ghcr.io/${{ github.repository_owner }}/flyway:latest
